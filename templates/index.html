<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduMate</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      #voice-input-checkbox {
  /* Hide the default checkbox appearance */
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  /* Style the button */
  width: 40px;  /* Adjust width as needed */
  height: 40px; /* Adjust height as needed */
  border: 2px solid #ccc;
  border-radius: 50%; /* Make it circular */
  background-color: #fff;
  cursor: pointer;

  /* Add a microphone icon */
  background-image: url("microphone-icon.png"); /* Replace with your icon path */
  background-repeat: no-repeat;
  background-position: center;

  /* Transition for smooth hover effect */
  transition: background-color 0.2s ease-in-out;
}

#voice-input-checkbox:hover {
  background-color: #ddd; /* Highlight on hover */
}

#voice-input-checkbox:checked {
  /* Optional: Style for checked state */
  background-color: #008000; /* Green for active state */
}

    </style>
</head>

<body class="bg-gray-100" style="display: flex; flex-wrap: nowrap;">
    <div id="chat-container" class="mt-4 ml-4 p-8 border rounded-lg bg-white shadow-lg" style="width: 115%; height: 95vh; display: flex; flex-direction: column; justify-content: space-between;">
        <div id="chat-display" class="p-8 border rounded-lg overflow-y-scroll bg-gray-200" style="flex-grow: 1;">
            
            {% for entry in chat_history %}
            <div class="{{ entry.role }} mb-4 p-4 rounded-md">{{ entry.content }}</div>
            {% endfor %}
        </div>
        
        <div class="flex items-center mt-4 rounded-md justify-between" style="width: 100%; "> 
            <input type="text" id="user-input" name="query" placeholder="Type your message..."
            class="p-4 border-none rounded-l-md" style="flex-grow: 1; border: 1px solid grey;"> 
            
            <div>
                <button onclick="sendMessage()"
                class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-r-md" style="border: 1px solid grey;">Send</button>
                
               

            </div>
            <div><input type="checkbox" style="margin-left: 5px;" id="voice-input-checkbox" onchange="toggleVoiceInput()"></div>
        </div>
    </div>
    
    
</div>

<div class="mt-4 mx-4  border rounded-lg bg-white shadow-lg" style="width:100%">
    <div id="image-container" class="mt-4 mx-4 border rounded-lg bg-white shadow-lg" ></div>
    
    {% if image_url %}
    <img src="{{ image_url }}" alt="Search Result">
    {% endif %}
        <img id="default-image" src="{{url_for('static', filename='still.gif')}}" alt="Default Image" style="width: 120%; height: 120%; object-fit: contain; position: absolute; height: 400px; right: -30%; top: 40%">
    
        <img id="speaking-image" src="{{url_for('static', filename='talking.gif')}}" alt="Speaking Image"
            class="hidden" style="width: 120%; height: 120%; object-fit: contain; position: absolute; height: 400px; right: -30%; top: 40%">
    </div>
    









    <script>
        var ttsPlaying = false;
        var voiceInputEnabled = false;
        var recognition = new webkitSpeechRecognition();

        recognition.onresult = function (event) {
            var userMessage = event.results[0][0].transcript;
            document.getElementById('user-input').value = userMessage;
            sendMessage();
        };


function speakWithGTTS(text) {
    var gttsSpeech = new SpeechSynthesisUtterance();
    gttsSpeech.text = text;

    var voices = window.speechSynthesis.getVoices();

    var femaleVoice = voices.find(voice => voice.name.toLowerCase().includes('female') && voice.lang.includes(
        'en'));

    gttsSpeech.voice = femaleVoice || voices[0];

    gttsSpeech.pitch = 1.0;
    gttsSpeech.rate = 0.9;


    speechSynthesis.speak(gttsSpeech);
    ttsPlaying = true;


    gttsSpeech.onend = function () {
        toggleImagesVisibility(false);
        ttsPlaying = false;
    };
}

function sendMessage() {
    var userMessage = document.getElementById('user-input').value;
    displayMessage('user', userMessage);
    if (voiceInputEnabled) {
                startVoiceInput();
            }

    fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'user_message=' + encodeURIComponent(userMessage),
        })
        .then(response => response.json())
        .then(data => {
            var assistantResponse = data.assistant_response;
            displayMessage('assistant', assistantResponse);

            var imageUrl = data.image_url;
            if (imageUrl) {
 
                displayImage(imageUrl);
            }

            toggleImagesVisibility(true);

            if (ttsPlaying) {
                stopTTS();
            }

            speakWithGTTS(assistantResponse);
        })
        .catch(error => {
            console.error('Error:', error);
            displayMessage('system', 'An error occurred while sending the message.');
        });

    document.getElementById('user-input').value = '';
}

function displayImage(imageUrl) {
    var imageContainer = document.getElementById('image-container');
    imageContainer.innerHTML = `<img src="${imageUrl}" alt="Physics Image" style="max-width: 100%; max-height: 100%;">`;
}



function toggleImagesVisibility(speaking) {
    var defaultImage = document.getElementById('default-image');
    var speakingImage = document.getElementById('speaking-image');

    if (speaking) {
        defaultImage.classList.add('hidden');
        speakingImage.classList.remove('hidden');
    } else {
        defaultImage.classList.remove('hidden');
        speakingImage.classList.add('hidden');
    }
}

function displayMessage(role, content) {
    var chatDisplay = document.getElementById('chat-display');
    var messageDiv = document.createElement('div');
    messageDiv.classList.add(role, 'mb-2', 'p-2', 'rounded-md');
    messageDiv.textContent = content;
    chatDisplay.appendChild(messageDiv);
}



function toggleVoiceInput() {
            voiceInputEnabled = document.getElementById('voice-input-checkbox').checked;
            if (voiceInputEnabled) {
                startVoiceInput();
            } else {
                stopVoiceInput();
            }
        }


        function startVoiceInput() {
            recognition.start();
        }

        function stopVoiceInput() {
            recognition.stop();
        }



function stopTTS() {
    ttsPlaying = false;
    speechSynthesis.cancel();
}

function toggleFileInput() {
    var fileInput = document.getElementById('image-input');
    fileInput.click();
}

document.getElementById('image-input').addEventListener('change', function (event) {
    var fileName = event.target.files[0].name;
    document.getElementById('user-input').value = 'Image attached: ' + fileName;
});

    </script>

</body>

</html>


